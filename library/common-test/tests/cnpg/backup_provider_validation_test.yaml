suite: cnpg backup provider validation test
templates:
  - common.yaml
release:
  name: test-release-name
  namespace: test-release-namespace
tests:
  - it: should fail with missing storageAccount or connectionString with azure provider
    set:
      credentials:
        test:
          type: azure
          storageKey: test
      cnpg:
        my-pg:
          enabled: true
          backups:
            enabled: true
            credentials: test
            manualBackups:
              - name: today
    asserts:
      - failedTemplate:
          errorMessage: CNPG Backup - Expected [backups.azure.storageAccount] OR [backups.azure.connectionString] to be defined and non-empty when provider is set to [azure]

  - it: should fail with missing storageKey or storageSasToken with azure provider
    set:
      credentials:
        test:
          type: azure
          storageAccount: test
      cnpg:
        my-pg:
          enabled: true
          backups:
            enabled: true
            credentials: test
            manualBackups:
              - name: today
    asserts:
      - failedTemplate:
          errorMessage: CNPG Backup - Expected [backups.azure.storageKey] OR [backups.azure.storageSasToken] to be defined and non-empty when provider is set to [azure]

  - it: should fail with both storageKey and storageSasToken defined with azure provider
    set:
      credentials:
        test:
          type: azure
          storageAccount: test
          storageKey: test
          storageSasToken: test
      cnpg:
        my-pg:
          enabled: true
          backups:
            enabled: true
            credentials: test
            manualBackups:
              - name: today
    asserts:
      - failedTemplate:
          errorMessage: CNPG Backup - Expected only one of [backups.azure.storageKey, backups.azure.storageSasToken] to be defined and non-empty when provider is set to [azure]

  - it: should fail with applicationCredentials missing with google provider
    set:
      credentials:
        test:
          type: google
          gkeEnvironment: false
      cnpg:
        my-pg:
          enabled: true
          backups:
            enabled: true
            credentials: test
            manualBackups:
              - name: today
    asserts:
      - failedTemplate:
          errorMessage: CNPG Backup - Expected [backups.google.applicationCredentials] to be defined and non-empty when provider is set to [google]

  - it: should fail with accessKey missing with s3 provider
    set:
      credentials:
        test:
          type: s3
          secretKey: test
      cnpg:
        my-pg:
          enabled: true
          backups:
            enabled: true
            credentials: test
            manualBackups:
              - name: today
    asserts:
      - failedTemplate:
          errorMessage: CNPG Backup - Expected [backups.s3.accessKey] to be defined and non-empty when provider is set to [s3]

  - it: should fail with secretKey missing with s3 provider
    set:
      credentials:
        test:
          type: s3
          accessKey: test
      cnpg:
        my-pg:
          enabled: true
          backups:
            enabled: true
            credentials: test
            manualBackups:
              - name: today
    asserts:
      - failedTemplate:
          errorMessage: CNPG Backup - Expected [backups.s3.secretKey] to be defined and non-empty when provider is set to [s3]
